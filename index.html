<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="./favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fairental Insurance & Maintenance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      html, body {
        font-family: 'Inter', sans-serif;
      }
    </style>
    <!-- Add Babel for in-browser JSX/TSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
{
  "imports": {
    "react-dom/client": "https://aistudiocdn.com/react-dom@19.2.0/client",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.29.0",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "xlsx": "https://aistudiocdn.com/xlsx@^0.18.5",
    "@supabase/supabase-js": "https://aistudiocdn.com/@supabase/supabase-js@^2.80.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
  <body class="bg-slate-100 dark:bg-slate-900">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
import ReactDOM from 'react-dom/client';
import { createClient } from '@supabase/supabase-js';
import { GoogleGenAI } from "@google/genai";
import * as xlsx from 'xlsx';

// --- START: services/supabaseService.ts ---
const supabaseUrl = 'https://zwukpsabeeskniakuiya.supabase.co';
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3dWtwc2FiZWVza25pYWt1aXlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3Nzg5NzcsImV4cCI6MjA3ODM1NDk3N30.BizoJIhZdlEzhgeML7B-xqjZHD2-3Dx4wrDZm84g9LA';
const supabase = createClient(supabaseUrl, supabaseAnonKey);

const getVehicles = async () => {
    const { data, error } = await supabase
        .from('vehicles')
        .select('*')
        .order('created_at', { ascending: false });
    if (error) {
        console.error('Error fetching vehicles:', error);
        throw error;
    }
    return data || [];
};

const addVehicle = async (vehicle) => {
    const { data, error } = await supabase
        .from('vehicles')
        .insert([vehicle])
        .select();
    if (error) {
        console.error('Error adding vehicle:', error);
        throw error;
    }
    return data;
};

const updateVehicle = async (id, updates) => {
    const updatesWithTimestamp = {
        ...updates,
        updated_at: new Date().toISOString(),
    };
    const { data, error } = await supabase
        .from('vehicles')
        .update(updatesWithTimestamp)
        .eq('id', id)
        .select();
    if (error) {
        console.error('Error updating vehicle:', error);
        throw error;
    }
    return data;
};

const deleteVehicle = async (id) => {
    const { error } = await supabase
        .from('vehicles')
        .delete()
        .eq('id', id);
    if (error) {
        console.error('Error deleting vehicle:', error);
    }
};

const batchAddVehicles = async (vehicles) => {
    const { data, error } = await supabase
        .from('vehicles')
        .insert(vehicles)
        .select();
    if (error) {
        console.error('Error batch adding vehicles:', error);
        throw error;
    }
    return data;
};
// --- END: services/supabaseService.ts ---

// --- START: services/geminiService.ts ---
const summarizeNotes = async (notes) => {
    if (!notes || notes.trim() === '') {
        return "No notes to summarize.";
    }
    try {
        const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: `Summarize the following vehicle maintenance notes in a few bullet points:\n\n---\n${notes}\n---`,
        });
        return response.text;
    } catch (error) {
        console.error("Error with Gemini API:", error);
        if (error instanceof Error && (error.message.includes("API key not valid") || error.message.includes("API key is missing"))) {
             return "Could not generate summary. The API key is not configured or is invalid.";
        }
        if (typeof ReferenceError !== 'undefined' && error instanceof ReferenceError && error.message.includes("process is not defined")) {
             return "Could not generate summary. The application is not configured for API access.";
        }
        return "Could not generate summary due to an API error.";
    }
};
// --- END: services/geminiService.ts ---

// --- START: utils/dateUtils.ts ---
const isWithinDays = (dateString, days) => {
    if (!dateString) return false;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const parts = dateString.split('-').map(part => parseInt(part, 10));
    if (parts.length !== 3 || parts.some(isNaN)) return false;
    const targetDate = new Date(parts[0], parts[1] - 1, parts[2]);
    if (isNaN(targetDate.getTime())) return false;
    const diffTime = targetDate.getTime() - today.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays <= days;
};

const isDatePast = (dateString) => {
    if (!dateString) return false;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const parts = dateString.split('-').map(part => parseInt(part, 10));
    if (parts.length !== 3 || parts.some(isNaN)) return false;
    const targetDate = new Date(parts[0], parts[1] - 1, parts[2]);
    if (isNaN(targetDate.getTime())) return false;
    return targetDate.getTime() < today.getTime();
};

const formatDate = (dateString) => {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    if (isNaN(date.getTime())) return 'Invalid Date';
    const year = date.getUTCFullYear();
    const month = (date.getUTCMonth() + 1).toString().padStart(2, '0');
    const day = date.getUTCDate().toString().padStart(2, '0');
    return `${year}-${month}-${day}`;
};

const formatDateDisplay = (dateString) => {
    if (!dateString) return 'N/A';
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const parts = dateString.split('-').map(part => parseInt(part, 10));
    if (parts.length !== 3 || parts.some(isNaN)) return 'Invalid Date';
    const targetDate = new Date(parts[0], parts[1] - 1, parts[2]);
    if (isNaN(targetDate.getTime())) return 'Invalid Date';
    const diffTime = targetDate.getTime() - today.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    if (diffDays > 0) return `in ${diffDays}d`;
    if (diffDays === 0) return 'Today';
    return formatDate(dateString);
};

const isToday = (dateString) => {
    if (!dateString) return false;
    const today = new Date();
    const targetDate = new Date(dateString);
    if (isNaN(targetDate.getTime())) return false;
    return targetDate.getUTCFullYear() === today.getUTCFullYear() &&
           targetDate.getUTCMonth() === today.getUTCMonth() &&
           targetDate.getUTCDate() === today.getUTCDate();
};
// --- END: utils/dateUtils.ts ---

// --- START: utils/excelUtils.ts ---
const formatVehiclesForExport = (vehicles) => {
    return vehicles.map(v => ({
        'Make': v.make,
        'Model': v.model,
        'Year': v.year,
        'License Plate': v.license_plate,
        'VIN': v.vin,
        'Color': v.color,
        'Renter Status': v.renter_status,
        'Renter Name': v.renter_name,
        'Insurance Company': v.insurance_company,
        'Insurance Renewal Date': formatDate(v.insurance_renewal_date),
        'Next Maintenance Date': formatDate(v.next_maintenance_date),
        'Notes': v.notes || '',
        'Created At': v.created_at ? formatDate(new Date(v.created_at).toISOString().split('T')[0]) : 'N/A',
        'Updated At': v.updated_at ? formatDate(new Date(v.updated_at).toISOString().split('T')[0]) : 'N/A',
    }));
};

const exportToExcel = (vehicles, fileName) => {
    if (vehicles.length === 0) {
        console.warn("No data to export.");
        return;
    }
    const formattedData = formatVehiclesForExport(vehicles);
    const worksheet = xlsx.utils.json_to_sheet(formattedData);
    const workbook = xlsx.utils.book_new();
    xlsx.utils.book_append_sheet(workbook, worksheet, 'Vehicles');
    const columnWidths = [
        { wch: 15 }, { wch: 20 }, { wch: 8 }, { wch: 15 }, { wch: 20 }, { wch: 12 },
        { wch: 12 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 50 },
        { wch: 15 }, { wch: 15 },
    ];
    worksheet['!cols'] = columnWidths;
    xlsx.writeFile(workbook, fileName);
};
// --- END: utils/excelUtils.ts ---

// --- START: components/icons.tsx ---
const CarIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.125-.504 1.125-1.125V14.25m-17.25 4.5v-1.875a3.375 3.375 0 003.375-3.375h1.5a1.125 1.125 0 011.125 1.125v-1.5c0-.621.504-1.125 1.125-1.125h3.75c.621 0 1.125.504 1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125h1.5a3.375 3.375 0 003.375 3.375v1.875m-17.25 4.5a3.375 3.375 0 003.375 3.375h9.75a3.375 3.375 0 003.375-3.375m-16.5 0a3.375 3.375 0 013.375-3.375h9.75a3.375 3.375 0 013.375 3.375m-16.5 0h16.5" />
    </svg>
);
const UploadIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
    </svg>
);
const ExportIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
    </svg>
);
const EditIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
  </svg>
);
const TrashIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.144-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.057-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
  </svg>
);
const NotesIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
  </svg>
);
const SparklesIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.572L16.5 21.75l-.398-1.178a3.375 3.375 0 00-2.923-2.923L12 17.25l1.178-.398a3.375 3.375 0 002.923-2.923L16.5 12.75l.398 1.178a3.375 3.375 0 002.923 2.923L21 17.25l-1.178.398a3.375 3.375 0 00-2.923 2.923z" />
    </svg>
);
const SettingsIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M9.594 3.94c.09-.542.56-1.007 1.11-.95.27.03.54.163.79.357.25.195.45.45.59.753.14.303.22.633.22.974s-.08.67-.22.973c-.14.303-.34.558-.59.753a1.73 1.73 0 01-.79.357c-.55.056-1.02-.408-1.11-.95a2.203 2.203 0 01-.22-1.947c.14-.303.34-.558.59-.753.25-.194.52-.326.79-.356.09-.01.18-.01.27 0zM12 20.25a.75.75 0 01.75-.75H13.5a.75.75 0 010 1.5H12.75a.75.75 0 01-.75-.75zM12 15a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM12 9a.75.75 0 01.75-.75h.75a.75.75 0 010 1.5h-.75A.75.75 0 0112 9zM12 3.75a.75.75 0 01.75-.75h3a.75.75 0 010 1.5h-3a.75.75 0 01-.75-.75zM8.25 15a.75.75 0 01.75-.75h.75a.75.75 0 010 1.5h-.75a.75.75 0 01-.75-.75zM9 9.75a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5A.75.75 0 019 9.75zM9.75 4.5a.75.75 0 01.75-.75h3a.75.75 0 010 1.5h-3a.75.75 0 01-.75-.75zM4.5 15a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM6 9.75a.75.75 0 01.75-.75h.75a.75.75 0 010 1.5h-.75A.75.75 0 016 9.75zM6.75 4.5a.75.75 0 01.75-.75h.75a.75.75 0 010 1.5h-.75a.75.75 0 01-.75-.75zM15 20.25a.75.75 0 01.75-.75h.75a.75.75 0 010 1.5h-.75a.75.75 0 01-.75-.75zM15.75 15a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM16.5 9a.75.75 0 01.75-.75h.75a.75.75 0 010 1.5h-.75a.75.75 0 01-.75-.75zM18 4.5a.75.75 0 01.75-.75h.75a.75.75 0 010 1.5h-.75a.75.75 0 01-.75-.75z" />
    </svg>
);
const SearchIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
    </svg>
);
const CheckCircleIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
);
const XCircleIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
);
const ArrowUpIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
    </svg>
);
const ArrowDownIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
    </svg>
);
// --- END: components/icons.tsx ---

// --- START: components/Spinner.tsx ---
const Spinner = ({ small = false }) => {
    const sizeClass = small ? 'h-5 w-5' : 'h-8 w-8';
    const borderClass = small ? 'border-2' : 'border-4';
    return <div className={`${sizeClass} ${borderClass} border-slate-500 border-t-transparent rounded-full animate-spin`} role="status" aria-label="Loading..."></div>;
};
// --- END: components/Spinner.tsx ---

// --- START: components/Header.tsx ---
const Header = ({ onAddVehicle, onFileUpload, onOpenSettings, onOpenExport, onExportTodaysUpdates }) => {
    const fileInputRef = useRef(null);
    const handleFileChange = (event) => {
        const file = event.target.files?.[0];
        if (file) {
            onFileUpload(file);
            if(fileInputRef.current) {
                fileInputRef.current.value = '';
            }
        }
    };
    const handleImportClick = () => fileInputRef.current?.click();
    return (
        <header className="bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm border-b border-slate-200 dark:border-slate-700/50 sticky top-0 z-40">
            <div className="container mx-auto px-4 md:px-8 py-4 flex justify-between items-center">
                <div className="flex items-center space-x-3">
                    <CarIcon className="h-8 w-8 text-slate-600 dark:text-slate-400" />
                    <h1 className="text-2xl font-bold text-slate-800 dark:text-white">Fairental Tracker</h1>
                </div>
                <div className="flex items-center space-x-1 md:space-x-2">
                     <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".xlsx, .xls" />
                    <button onClick={handleImportClick} className="flex items-center space-x-2 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold py-2 px-3 rounded-lg transition-colors duration-200 text-sm">
                        <UploadIcon className="h-4 w-4" />
                        <span className="hidden sm:inline">Import</span>
                    </button>
                     <button onClick={onOpenExport} className="flex items-center space-x-2 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold py-2 px-3 rounded-lg transition-colors duration-200 text-sm">
                        <ExportIcon className="h-4 w-4" />
                        <span className="hidden sm:inline">Export</span>
                    </button>
                    <button onClick={onExportTodaysUpdates} className="flex items-center space-x-2 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-600 font-semibold py-2 px-3 rounded-lg transition-colors duration-200 text-sm" title="Export vehicles created or updated today">
                        <ExportIcon className="h-4 w-4" />
                        <span className="hidden sm:inline">Today's Log</span>
                    </button>
                    <button onClick={onAddVehicle} className="bg-slate-800 hover:bg-slate-900 dark:bg-slate-700 dark:hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 text-sm">
                        + Add Vehicle
                    </button>
                    <button onClick={onOpenSettings} className="p-2 rounded-full text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 dark:focus:ring-offset-slate-800" aria-label="Settings">
                        <SettingsIcon className="h-5 w-5" />
                    </button>
                </div>
            </div>
        </header>
    );
};
// --- END: components/Header.tsx ---

// --- START: components/FilterControls.tsx ---
const FilterControls = ({ activeFilter, onFilterChange, insuranceDays, maintenanceDays, searchQuery, onSearchChange }) => {
    const filters = [
        { id: 'all', label: 'All Vehicles' },
        { id: 'insurance', label: `Insurance Due (${insuranceDays}d)` },
        { id: 'maintenance', label: `Maintenance Due (${maintenanceDays}d)` },
        { id: 'insurance_expired', label: 'Expired' },
        { id: 'maintenance_overdue', label: 'Overdue' },
    ];
    return (
        <div className="mb-6 bg-white/70 dark:bg-slate-800/50 backdrop-blur-sm p-3 rounded-xl shadow-sm flex flex-col md:flex-row flex-wrap items-center gap-3">
            <div className="flex-grow w-full md:w-auto">
                <div className="relative">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><SearchIcon className="h-5 w-5 text-slate-400" /></div>
                    <input type="text" placeholder="Search by make, model, VIN, renter..." value={searchQuery} onChange={(e) => onSearchChange(e.target.value)} className="w-full pl-10 pr-4 py-2 text-sm border-slate-300 rounded-lg dark:bg-slate-700 dark:border-slate-600 dark:text-white focus:ring-slate-500 focus:border-slate-500" />
                </div>
            </div>
             <div className="flex flex-col sm:flex-row flex-wrap items-center gap-2">
                {filters.map(filter => (
                    <button key={filter.id} onClick={() => onFilterChange(filter.id)} className={`w-full sm:w-auto px-4 py-2 text-sm font-semibold rounded-lg transition-all duration-200 text-center ${activeFilter === filter.id ? 'bg-slate-800 dark:bg-slate-700 text-white shadow-md' : 'bg-transparent text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700/50'}`}>
                        {filter.label}
                    </button>
                ))}
            </div>
        </div>
    );
};
// --- END: components/FilterControls.tsx ---

// --- START: components/VehicleItem.tsx ---
const VehicleItem = ({ vehicle, onEdit, onDelete, onViewNotes, insuranceReminderDays, maintenanceReminderDays }) => {
    const insuranceExpiring = isWithinDays(vehicle.insurance_renewal_date, insuranceReminderDays);
    const maintenanceDue = isWithinDays(vehicle.next_maintenance_date, maintenanceReminderDays);
    const getHighlightClass = (isUrgent) => isUrgent ? 'text-rose-600 dark:text-rose-400 font-semibold' : '';

    return (
        <tr className="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors duration-150">
            <td className="px-6 py-5 whitespace-nowrap">
                <div className="text-sm font-semibold text-slate-900 dark:text-white">{`${vehicle.year} ${vehicle.make} ${vehicle.model}`}</div>
                <div className="text-sm text-slate-500 dark:text-slate-400">{vehicle.license_plate}</div>
                {vehicle.renter_name && <div className="text-sm text-slate-500 dark:text-slate-400 font-medium">{vehicle.renter_name}</div>}
                 <div className="text-sm text-slate-500 dark:text-slate-400 lg:hidden mt-1">{vehicle.vin}</div>
            </td>
            <td className="px-6 py-5 whitespace-nowrap hidden lg:table-cell text-sm text-slate-500 dark:text-slate-400">{vehicle.vin}</td>
            <td className="px-6 py-5 whitespace-nowrap hidden sm:table-cell">
                <span className={`px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full ${vehicle.renter_status && vehicle.renter_status.toLowerCase() === 'active' ? 'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300' : 'bg-slate-100 text-slate-800 dark:bg-slate-700/60 dark:text-slate-300'}`}>
                    {vehicle.renter_status}
                </span>
            </td>
            <td className={`px-6 py-5 whitespace-nowrap text-sm ${getHighlightClass(insuranceExpiring)}`}>
                <div>{formatDateDisplay(vehicle.insurance_renewal_date)}</div>
                <div className="text-xs text-slate-500 dark:text-slate-400">{vehicle.insurance_company}</div>
            </td>
            <td className={`px-6 py-5 whitespace-nowrap text-sm ${getHighlightClass(maintenanceDue)}`}>
                {formatDateDisplay(vehicle.next_maintenance_date)}
            </td>
            <td className="px-6 py-5 whitespace-nowrap text-right text-sm font-medium">
                <div className="flex justify-end items-center space-x-4">
                    <button onClick={() => onViewNotes(vehicle)} className="text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 transition-colors" title="View Notes"><NotesIcon className="h-5 w-5" /></button>
                    <button onClick={() => onEdit(vehicle)} className="text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 transition-colors" title="Edit Vehicle"><EditIcon className="h-5 w-5" /></button>
                    <button onClick={() => onDelete(vehicle.id)} className="text-rose-500 hover:text-rose-700 dark:hover:text-rose-400 transition-colors" title="Delete Vehicle"><TrashIcon className="h-5 w-5" /></button>
                </div>
            </td>
        </tr>
    );
};
// --- END: components/VehicleItem.tsx ---

// --- START: components/VehicleList.tsx ---
const VehicleList = ({ vehicles, onEdit, onDelete, onViewNotes, insuranceReminderDays, maintenanceReminderDays, sortKey, sortDirection, onSort }) => {
    const renderSortIcon = (key) => {
        if (sortKey !== key) return <ArrowUpIcon className="w-4 h-4 text-slate-400 opacity-40 group-hover:opacity-100" />;
        return sortDirection === 'asc' ? <ArrowUpIcon className="w-4 h-4" /> : <ArrowDownIcon className="w-4 h-4" />;
    };
    if (vehicles.length === 0) {
        return (
            <div className="text-center py-20 px-4 bg-white dark:bg-slate-800 rounded-xl shadow-md">
                <CarIcon className="mx-auto h-16 w-16 text-slate-400" />
                <h3 className="mt-4 text-xl font-semibold text-slate-900 dark:text-white">No vehicles found</h3>
                <p className="mt-2 text-base text-slate-500 dark:text-slate-400">Try changing the filter or add a new vehicle.</p>
            </div>
        );
    }
    return (
        <div className="bg-white dark:bg-slate-800 shadow-lg rounded-xl overflow-hidden">
            <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                    <thead className="bg-slate-50 dark:bg-slate-700/50">
                        <tr>
                            <th scope="col" className="px-6 py-4 text-left text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Vehicle</th>
                            <th scope="col" className="px-6 py-4 text-left text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider hidden lg:table-cell">VIN</th>
                            <th scope="col" className="px-6 py-4 text-left text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider hidden sm:table-cell">Status</th>
                            <th scope="col" className="px-6 py-4 text-left text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider cursor-pointer group" onClick={() => onSort('insurance_renewal_date')}>
                                <div className="flex items-center space-x-1"><span>Insurance</span>{renderSortIcon('insurance_renewal_date')}</div>
                            </th>
                            <th scope="col" className="px-6 py-4 text-left text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider cursor-pointer group" onClick={() => onSort('next_maintenance_date')}>
                                <div className="flex items-center space-x-1"><span>Maintenance</span>{renderSortIcon('next_maintenance_date')}</div>
                            </th>
                            <th scope="col" className="relative px-6 py-3"><span className="sr-only">Actions</span></th>
                        </tr>
                    </thead>
                    <tbody className="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                        {vehicles.map(vehicle => <VehicleItem key={vehicle.id} vehicle={vehicle} onEdit={onEdit} onDelete={onDelete} onViewNotes={onViewNotes} insuranceReminderDays={insuranceReminderDays} maintenanceReminderDays={maintenanceReminderDays} />)}
                    </tbody>
                </table>
            </div>
        </div>
    );
};
// --- END: components/VehicleList.tsx ---

// --- START: components/VehicleFormModal.tsx ---
const VehicleFormModal = ({ isOpen, onClose, onSubmit, vehicle }) => {
    const [formData, setFormData] = useState({ make: '', model: '', year: new Date().getFullYear(), license_plate: '', vin: '', color: '', renter_name: '', insurance_company: '', insurance_renewal_date: '', next_maintenance_date: '', renter_status: 'Active', notes: '' });
    useEffect(() => {
        if (vehicle) {
            setFormData({
                make: vehicle.make || '', model: vehicle.model || '', year: vehicle.year || new Date().getFullYear(), license_plate: vehicle.license_plate || '', vin: vehicle.vin || '', color: vehicle.color || '',
                renter_name: vehicle.renter_name || '', insurance_company: vehicle.insurance_company || '', insurance_renewal_date: vehicle.insurance_renewal_date || '', next_maintenance_date: vehicle.next_maintenance_date || '',
                renter_status: vehicle.renter_status || 'Active', notes: vehicle.notes || ''
            });
        } else {
            setFormData({ make: '', model: '', year: new Date().getFullYear(), license_plate: '', vin: '', color: '', renter_name: '', insurance_company: '', insurance_renewal_date: '', next_maintenance_date: '', renter_status: 'Active', notes: '' });
        }
    }, [vehicle, isOpen]);
    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: name === 'year' ? parseInt(value) : value }));
    };
    const handleSubmit = (e) => {
        e.preventDefault();
        onSubmit(formData);
    };
    if (!isOpen) return null;
    const inputClass = "mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 shadow-sm focus:border-slate-500 focus:ring-slate-500 sm:text-sm bg-slate-100 dark:bg-slate-700 dark:text-white";
    return (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-start z-50 p-4 overflow-y-auto">
            <div className="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-3xl mx-auto my-8">
                <form onSubmit={handleSubmit}>
                    <div className="p-8">
                        <h2 className="text-2xl font-bold text-slate-900 dark:text-white mb-6">{vehicle ? 'Edit Vehicle' : 'Add New Vehicle'}</h2>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div><label htmlFor="make" className="block text-sm font-medium text-slate-700 dark:text-slate-300">Make</label><input type="text" name="make" id="make" value={formData.make} onChange={handleChange} required className={inputClass} /></div>
                            <div><label htmlFor="model" className="block text-sm font-medium text-slate-700 dark:text-slate-300">Model</label><input type="text" name="model" id="model" value={formData.model} onChange={handleChange} required className={inputClass} /></div>
                            <div><label htmlFor="year" className="block text-sm font-medium text-slate-700 dark:text-slate-300">Year</label><input type="number" name="year" id="year" value={formData.year} onChange={handleChange} required className={inputClass} /></div>
                            <div><label htmlFor="license_plate" className="block text-sm font-medium text-slate-700 dark:text-slate-300">License Plate</label><input type="text" name="license_plate" id="license_plate" value={formData.license_plate} onChange={handleChange} required className={inputClass} /></div>
                            <div className="md:col-span-2"><label htmlFor="vin" className="block text-sm font-medium text-slate-700 dark:text-slate-300">VIN</label><input type="text" name="vin" id="vin" value={formData.vin} onChange={handleChange} required className={inputClass} /></div>
                            <div><label htmlFor="color" className="block text-sm font-medium text-slate-700 dark:text-slate-300">Color</label><input type="text" name="color" id="color" value={formData.color} onChange={handleChange} className={inputClass} /></div>
                            <div><label htmlFor="renter_name" className="block text-sm font-medium text-slate-700 dark:text-slate-300">Renter Name</label><input type="text" name="renter_name" id="renter_name" value={formData.renter_name} onChange={handleChange} className={inputClass} /></div>
                            <div className="md:col-span-2"><label htmlFor="insurance_company" className="block text-sm font-medium text-slate-700 dark:text-slate-300">Insurance Company</label><input type="text" name="insurance_company" id="insurance_company" value={formData.insurance_company} onChange={handleChange} className={inputClass} /></div>
                            <div><label htmlFor="insurance_renewal_date" className="block text-sm font-medium text-slate-700 dark:text-slate-300">Insurance Renewal Date</label><input type="date" name="insurance_renewal_date" id="insurance_renewal_date" value={formData.insurance_renewal_date} onChange={handleChange} required className={inputClass} /></div>
                            <div><label htmlFor="next_maintenance_date" className="block text-sm font-medium text-slate-700 dark:text-slate-300">Next Maintenance Date</label><input type="date" name="next_maintenance_date" id="next_maintenance_date" value={formData.next_maintenance_date} onChange={handleChange} required className={inputClass} /></div>
                            <div className="md:col-span-2"><label htmlFor="renter_status" className="block text-sm font-medium text-slate-700 dark:text-slate-300">Renter Status</label><select id="renter_status" name="renter_status" value={formData.renter_status} onChange={handleChange} className={inputClass}><option>Active</option><option>Inactive</option></select></div>
                        </div>
                    </div>
                    <div className="bg-slate-50 dark:bg-slate-800/50 px-8 py-4 flex justify-end space-x-3 rounded-b-xl border-t border-slate-200 dark:border-slate-700">
                        <button type="button" onClick={onClose} className="py-2 px-5 bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm font-medium hover:bg-slate-50 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 dark:focus:ring-offset-slate-800">Cancel</button>
                        <button type="submit" className="py-2 px-5 bg-slate-700 text-white border border-transparent rounded-lg shadow-sm text-sm font-medium hover:bg-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 dark:focus:ring-offset-slate-800">Save Vehicle</button>
                    </div>
                </form>
            </div>
        </div>
    );
};
// --- END: components/VehicleFormModal.tsx ---

// --- START: components/NotesModal.tsx ---
const NotesModal = ({ isOpen, onClose, vehicle, onSave, summarizeNotes }) => {
    const [newNote, setNewNote] = useState('');
    const [summary, setSummary] = useState(null);
    const [isSummarizing, setIsSummarizing] = useState(false);
    const handleAddNote = async () => {
        if (!newNote.trim()) return;
        const timestamp = new Date().toLocaleString();
        const updatedNotes = vehicle.notes ? `${vehicle.notes}\n\n---\n[${timestamp}]\n${newNote}` : `[${timestamp}]\n${newNote}`;
        const { id, created_at, updated_at, ...vehicleData } = vehicle;
        const updatedVehicleData = { ...vehicleData, notes: updatedNotes };
        await onSave(updatedVehicleData);
        setNewNote('');
        setSummary(null);
    };
    const handleSummarize = async () => {
        setIsSummarizing(true);
        setSummary(null);
        const result = await summarizeNotes(vehicle.notes);
        setSummary(result);
        setIsSummarizing(false);
    };
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
            <div className="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-3xl mx-auto flex flex-col" style={{maxHeight: '90vh'}}>
                <div className="p-8 pb-4 border-b border-slate-200 dark:border-slate-700">
                    <h2 className="text-2xl font-bold text-slate-900 dark:text-white">Notes for {`${vehicle.year} ${vehicle.make} ${vehicle.model}`}</h2>
                    <p className="text-sm text-slate-500 dark:text-slate-400 mt-1">{vehicle.license_plate}</p>
                </div>
                <div className="p-8 flex-grow overflow-y-auto">
                    {(summary || isSummarizing) && (
                        <div className="mb-6 p-4 bg-slate-50 dark:bg-slate-900/40 rounded-lg border border-slate-200 dark:border-slate-700">
                            <h3 className="font-semibold text-slate-800 dark:text-slate-300 mb-2 flex items-center"><SparklesIcon className="h-5 w-5 mr-2 text-slate-500" /> AI Summary</h3>
                            {isSummarizing ? <div className="flex items-center space-x-2 text-sm text-slate-600 dark:text-slate-400"><Spinner small /><span>Generating summary...</span></div> : <p className="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap">{summary}</p>}
                        </div>
                    )}
                    <div className="whitespace-pre-wrap text-sm text-slate-700 dark:text-slate-300 bg-slate-50 dark:bg-slate-700/50 p-4 rounded-lg h-64 overflow-y-auto border border-slate-200 dark:border-slate-700">
                        {vehicle.notes || <span className="text-slate-400">No notes yet.</span>}
                    </div>
                    <div className="mt-4">
                        <textarea value={newNote} onChange={(e) => setNewNote(e.target.value)} placeholder="Add a new note..." rows={3} className="w-full rounded-lg border-slate-300 dark:border-slate-600 shadow-sm focus:border-slate-500 focus:ring-slate-500 sm:text-sm bg-slate-100 dark:bg-slate-700 dark:text-white" />
                    </div>
                </div>
                <div className="bg-slate-50 dark:bg-slate-800/50 px-8 py-4 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0 rounded-b-xl border-t border-slate-200 dark:border-slate-700">
                     <button onClick={handleSummarize} disabled={!vehicle.notes || isSummarizing} className="w-full sm:w-auto flex justify-center items-center space-x-2 py-2 px-4 bg-slate-200 text-slate-700 border border-transparent rounded-lg text-sm font-medium hover:bg-slate-300 disabled:bg-slate-200 disabled:text-slate-500 disabled:cursor-not-allowed dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600 dark:disabled:bg-slate-600 dark:disabled:text-slate-400">
                        <SparklesIcon className="h-5 w-5" /><span>Summarize Notes</span>
                    </button>
                    <div className="flex w-full sm:w-auto space-x-3">
                         <button type="button" onClick={onClose} className="flex-1 sm:flex-none py-2 px-5 bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm font-medium hover:bg-slate-50 dark:hover:bg-slate-600">Close</button>
                        <button onClick={handleAddNote} className="flex-1 sm:flex-none py-2 px-5 bg-slate-700 text-white border border-transparent rounded-lg shadow-sm text-sm font-medium hover:bg-slate-800">Add Note</button>
                    </div>
                </div>
            </div>
        </div>
    );
};
// --- END: components/NotesModal.tsx ---

// --- START: components/SettingsModal.tsx ---
const SettingsModal = ({ isOpen, onClose, onSave, currentSettings }) => {
    const [insurance, setInsurance] = useState(currentSettings.insurance);
    const [maintenance, setMaintenance] = useState(currentSettings.maintenance);
    useEffect(() => {
        setInsurance(currentSettings.insurance);
        setMaintenance(currentSettings.maintenance);
    }, [currentSettings, isOpen]);
    const handleSave = () => {
        const insuranceDays = insurance > 0 ? insurance : 1;
        const maintenanceDays = maintenance > 0 ? maintenance : 1;
        onSave({ insurance: insuranceDays, maintenance: maintenanceDays });
    };
    if (!isOpen) return null;
    const inputClass = "block w-full rounded-lg border-slate-300 dark:border-slate-600 shadow-sm focus:border-slate-500 focus:ring-slate-500 sm:text-sm bg-slate-100 dark:bg-slate-700 dark:text-white";
    return (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
            <div className="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-md mx-auto">
                <div className="p-8">
                    <h2 className="text-2xl font-bold text-slate-900 dark:text-white mb-6">Reminder Settings</h2>
                    <div className="space-y-6">
                        <div>
                            <label htmlFor="insurance-days" className="block text-sm font-medium text-slate-700 dark:text-slate-300">Insurance Renewal Reminder</label>
                            <div className="mt-1 flex items-center">
                                <input type="number" name="insurance-days" id="insurance-days" value={insurance} onChange={(e) => setInsurance(parseInt(e.target.value, 10) || 0)} min="1" className={inputClass} />
                                <span className="ml-3 text-sm text-slate-500 dark:text-slate-400">days before</span>
                            </div>
                        </div>
                        <div>
                             <label htmlFor="maintenance-days" className="block text-sm font-medium text-slate-700 dark:text-slate-300">Maintenance Due Reminder</label>
                            <div className="mt-1 flex items-center">
                                <input type="number" name="maintenance-days" id="maintenance-days" value={maintenance} onChange={(e) => setMaintenance(parseInt(e.target.value, 10) || 0)} min="1" className={inputClass} />
                                <span className="ml-3 text-sm text-slate-500 dark:text-slate-400">days before</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div className="bg-slate-50 dark:bg-slate-800/50 px-6 py-4 flex justify-end space-x-3 rounded-b-xl border-t border-slate-200 dark:border-slate-700">
                    <button type="button" onClick={onClose} className="py-2 px-5 bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm font-medium hover:bg-slate-50 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 dark:focus:ring-offset-slate-800">Cancel</button>
                    <button onClick={handleSave} className="py-2 px-5 bg-slate-700 text-white border border-transparent rounded-lg shadow-sm text-sm font-medium hover:bg-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 dark:focus:ring-offset-slate-800">Save Settings</button>
                </div>
            </div>
        </div>
    );
};
// --- END: components/SettingsModal.tsx ---

// --- START: components/ExportModal.tsx ---
const ExportModal = ({ isOpen, onClose, onExport }) => {
    const getTodayString = () => new Date().toISOString().split('T')[0];
    const [startDate, setStartDate] = useState(getTodayString());
    const [endDate, setEndDate] = useState(getTodayString());
    const [includeInsurance, setIncludeInsurance] = useState(true);
    const [includeMaintenance, setIncludeMaintenance] = useState(true);
    const [includeAll, setIncludeAll] = useState(false);
    const handleExport = () => {
        if (!includeAll && (!startDate || !endDate)) return alert('Please select a valid date range.');
        if (!includeAll && !includeInsurance && !includeMaintenance) return alert('Please select at least one data type to include in the report.');
        onExport({ startDate, endDate, includeInsurance, includeMaintenance, includeAll });
    };
    const handleIncludeAllChange = (e) => {
        const isChecked = e.target.checked;
        setIncludeAll(isChecked);
        setIncludeInsurance(isChecked ? false : true);
        setIncludeMaintenance(isChecked ? false : true);
    };
    if (!isOpen) return null;
    const inputClass = "mt-1 block w-full rounded-lg border-slate-300 dark:border-slate-600 shadow-sm focus:border-slate-500 focus:ring-slate-500 sm:text-sm bg-slate-100 dark:bg-slate-700 dark:text-white disabled:bg-slate-200 dark:disabled:bg-slate-700/50";
    return (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4">
            <div className="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg mx-auto">
                <div className="p-8">
                    <h2 className="text-2xl font-bold text-slate-900 dark:text-white mb-6">Custom Filter & Export</h2>
                    <div className="space-y-6">
                        <div className="relative flex items-start p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg border border-slate-200 dark:border-slate-700">
                            <div className="flex h-6 items-center"><input id="include-all" name="include-all" type="checkbox" checked={includeAll} onChange={handleIncludeAllChange} className="h-4 w-4 rounded border-gray-300 text-slate-600 focus:ring-slate-600 dark:bg-slate-700 dark:border-slate-600" /></div>
                            <div className="ml-3 text-sm leading-6">
                                <label htmlFor="include-all" className="font-medium text-slate-900 dark:text-slate-200">Export All Vehicles</label>
                                <p className="text-slate-500 dark:text-slate-400">Select this to ignore date filters and export all records.</p>
                            </div>
                        </div>
                        <div className={`transition-opacity duration-300 ${includeAll ? 'opacity-50 pointer-events-none' : 'opacity-100'}`}>
                            <fieldset className="space-y-6">
                                <div>
                                    <legend className="text-base font-semibold leading-6 text-slate-900 dark:text-white">Filter by Date Range</legend>
                                    <p className="text-sm text-slate-500 dark:text-slate-400 mb-2">Select a start and end date for the report.</p>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div><label htmlFor="start-date" className="block text-sm font-medium text-slate-700 dark:text-slate-300">Start Date</label><input type="date" name="start-date" id="start-date" value={startDate} onChange={(e) => setStartDate(e.target.value)} required className={inputClass} /></div>
                                        <div><label htmlFor="end-date" className="block text-sm font-medium text-slate-700 dark:text-slate-300">End Date</label><input type="date" name="end-date" id="end-date" value={endDate} onChange={(e) => setEndDate(e.target.value)} required className={inputClass} /></div>
                                    </div>
                                </div>
                                <div>
                                    <legend className="text-base font-semibold leading-6 text-slate-900 dark:text-white">Data to Include</legend>
                                    <p className="text-sm text-slate-500 dark:text-slate-400 mb-2">Choose which records to include based on the date range.</p>
                                    <div className="mt-4 space-y-4">
                                        <div className="relative flex items-start"><div className="flex h-6 items-center"><input id="include-insurance" name="include-insurance" type="checkbox" checked={includeInsurance} onChange={(e) => setIncludeInsurance(e.target.checked)} className="h-4 w-4 rounded border-gray-300 text-slate-600 focus:ring-slate-600 dark:bg-slate-700 dark:border-slate-600 disabled:opacity-50" /></div><div className="ml-3 text-sm leading-6"><label htmlFor="include-insurance" className="font-medium text-slate-900 dark:text-slate-200">Insurance Renewals in Range</label></div></div>
                                        <div className="relative flex items-start"><div className="flex h-6 items-center"><input id="include-maintenance" name="include-maintenance" type="checkbox" checked={includeMaintenance} onChange={(e) => setIncludeMaintenance(e.target.checked)} className="h-4 w-4 rounded border-gray-300 text-slate-600 focus:ring-slate-600 dark:bg-slate-700 dark:border-slate-600 disabled:opacity-50" /></div><div className="ml-3 text-sm leading-6"><label htmlFor="include-maintenance" className="font-medium text-slate-900 dark:text-slate-200">Maintenance Due in Range</label></div></div>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                    </div>
                </div>
                <div className="bg-slate-50 dark:bg-slate-800/50 px-8 py-4 flex justify-end space-x-3 rounded-b-xl border-t border-slate-200 dark:border-slate-700">
                    <button type="button" onClick={onClose} className="py-2 px-5 bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200 border border-slate-300 dark:border-slate-600 rounded-lg shadow-sm text-sm font-medium hover:bg-slate-50 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 dark:focus:ring-offset-slate-800">Cancel</button>
                    <button onClick={handleExport} className="py-2 px-5 bg-slate-700 text-white border border-transparent rounded-lg shadow-sm text-sm font-medium hover:bg-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 dark:focus:ring-offset-slate-800">Export to Excel</button>
                </div>
            </div>
        </div>
    );
};
// --- END: components/ExportModal.tsx ---

// --- START: App.tsx ---
const DEFAULT_INSURANCE_DAYS = 30;
const DEFAULT_MAINTENANCE_DAYS = 14;

const App = () => {
    const [vehicles, setVehicles] = useState([]);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [filter, setFilter] = useState('all');
    const [searchQuery, setSearchQuery] = useState('');
    const [sortKey, setSortKey] = useState(null);
    const [sortDirection, setSortDirection] = useState('asc');
    const [isFormModalOpen, setIsFormModalOpen] = useState(false);
    const [isNotesModalOpen, setIsNotesModalOpen] = useState(false);
    const [isSettingsModalOpen, setIsSettingsModalOpen] = useState(false);
    const [isExportModalOpen, setIsExportModalOpen] = useState(false);
    const [selectedVehicle, setSelectedVehicle] = useState(null);
    const [notification, setNotification] = useState(null);
    const [insuranceReminderDays, setInsuranceReminderDays] = useState(DEFAULT_INSURANCE_DAYS);
    const [maintenanceReminderDays, setMaintenanceReminderDays] = useState(DEFAULT_MAINTENANCE_DAYS);

    useEffect(() => {
        const savedInsuranceDays = localStorage.getItem('insuranceReminderDays');
        const savedMaintenanceDays = localStorage.getItem('maintenanceReminderDays');
        if (savedInsuranceDays) setInsuranceReminderDays(parseInt(savedInsuranceDays, 10));
        if (savedMaintenanceDays) setMaintenanceReminderDays(parseInt(savedMaintenanceDays, 10));
    }, []);

    const fetchVehicles = useCallback(async () => {
        setLoading(true);
        setError(null);
        try {
            const data = await getVehicles();
            setVehicles(data || []);
        } catch (err) {
            setError('Failed to fetch vehicles. Please ensure your Supabase credentials are correct and the table schema is updated.');
            console.error(err);
        } finally {
            setLoading(false);
        }
    }, []);

    useEffect(() => { fetchVehicles(); }, [fetchVehicles]);
    
    useEffect(() => {
        if (notification) {
            const timer = setTimeout(() => setNotification(null), 4000);
            return () => clearTimeout(timer);
        }
    }, [notification]);

    const handleAddVehicle = () => { setSelectedVehicle(null); setIsFormModalOpen(true); };
    const handleEditVehicle = (vehicle) => { setSelectedVehicle(vehicle); setIsFormModalOpen(true); };
    const handleViewNotes = (vehicle) => { setSelectedVehicle(vehicle); setIsNotesModalOpen(true); };

    const handleDeleteVehicle = async (id) => {
        if (window.confirm('Are you sure you want to delete this vehicle?')) {
            try {
                await deleteVehicle(id);
                setNotification({ message: 'Vehicle deleted successfully!', type: 'success' });
                fetchVehicles();
            } catch (err) {
                setNotification({ message: 'Failed to delete vehicle.', type: 'error' });
                console.error(err);
            }
        }
    };

    const handleFormSubmit = async (vehicleData) => {
        try {
            if (selectedVehicle) {
                await updateVehicle(selectedVehicle.id, vehicleData);
                setNotification({ message: 'Vehicle updated successfully!', type: 'success' });
            } else {
                await addVehicle(vehicleData);
                setNotification({ message: 'Vehicle added successfully!', type: 'success' });
            }
            fetchVehicles();
            setIsFormModalOpen(false);
            setSelectedVehicle(null);
        } catch (err) {
            setNotification({ message: 'Failed to save vehicle.', type: 'error' });
            console.error(err);
        }
    };
    
    const handleFileUpload = (file) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                if (!e.target?.result) {
                    setNotification({ message: 'Error reading file.', type: 'error' });
                    return;
                }
                const data = new Uint8Array(e.target.result);
                const workbook = xlsx.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = xlsx.utils.sheet_to_json(worksheet, { cellDates: true });

                const newVehicles = json.map(row => {
                    const normalizedRow = {};
                    for (const key in row) {
                        normalizedRow[key.trim().toLowerCase().replace(/\s+/g, '_')] = row[key];
                    }
                    const toYYYYMMDD = (date) => {
                        if (date instanceof Date && !isNaN(date.getTime())) {
                            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                            return new Date(date.getTime() - userTimezoneOffset).toISOString().split('T')[0];
                        }
                        if (typeof date === 'string') {
                            const parsedDate = new Date(date);
                             if (!isNaN(parsedDate.getTime())) {
                                const userTimezoneOffset = parsedDate.getTimezoneOffset() * 60000;
                                return new Date(parsedDate.getTime() - userTimezoneOffset).toISOString().split('T')[0];
                             }
                        }
                        return '';
                    };
                    const sixMonthsFromNow = new Date();
                    sixMonthsFromNow.setMonth(sixMonthsFromNow.getMonth() + 6);

                    return {
                        make: normalizedRow['make'] || '', model: normalizedRow['model'] || '', year: parseInt(normalizedRow['year'], 10) || new Date().getFullYear(),
                        license_plate: String(normalizedRow['plate_number'] || normalizedRow['license_plate'] || ''), vin: String(normalizedRow['vin'] || ''), color: String(normalizedRow['color'] || ''),
                        insurance_company: String(normalizedRow['insurance_company'] || ''), insurance_renewal_date: toYYYYMMDD(normalizedRow['insurance_expiry'] || normalizedRow['insurance_expir'] || normalizedRow['insurance_renewal_date']),
                        next_maintenance_date: toYYYYMMDD(normalizedRow['next_maintenance_date'] || sixMonthsFromNow), renter_status: String(normalizedRow['renter_status'] || 'Inactive'),
                        renter_name: String(normalizedRow['renter_name'] || ''), notes: String(normalizedRow['notes'] || ''),
                    };
                }).filter(v => {
                    const isActive = v.renter_status.toLowerCase() === 'active';
                    const hasRequiredFields = v.make && v.model && v.year && v.license_plate && v.vin && v.insurance_renewal_date;
                    return isActive && hasRequiredFields;
                });

                if (newVehicles.length > 0) {
                    await batchAddVehicles(newVehicles);
                    setNotification({ message: `${newVehicles.length} vehicles imported successfully!`, type: 'success' });
                    fetchVehicles();
                } else {
                    setNotification({ message: 'No valid "Active" vehicles found in the file. Check column names, data, and renter status.', type: 'error' });
                }
            } catch (err) {
                 setNotification({ message: 'Error processing Excel file. Please check format.', type: 'error' });
                 console.error(err);
            }
        };
        reader.readAsArrayBuffer(file);
    };

    const handleSaveSettings = (settings) => {
        setInsuranceReminderDays(settings.insurance);
        setMaintenanceReminderDays(settings.maintenance);
        localStorage.setItem('insuranceReminderDays', settings.insurance.toString());
        localStorage.setItem('maintenanceReminderDays', settings.maintenance.toString());
        setIsSettingsModalOpen(false);
        setNotification({ message: 'Reminder settings saved!', type: 'success' });
    };

    const handleExportData = (criteria) => {
        let dataToExport = [];
        const { startDate, endDate, includeInsurance, includeMaintenance, includeAll } = criteria;
        if (includeAll) {
            dataToExport = vehicles;
        } else {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const uniqueVehicles = new Map();
            vehicles.forEach(v => {
                if (includeInsurance) {
                    const insuranceDate = new Date(v.insurance_renewal_date);
                    if (insuranceDate >= start && insuranceDate <= end) uniqueVehicles.set(v.id, v);
                }
                if (includeMaintenance) {
                    const maintenanceDate = new Date(v.next_maintenance_date);
                    if (maintenanceDate >= start && maintenanceDate <= end) uniqueVehicles.set(v.id, v);
                }
            });
            dataToExport = Array.from(uniqueVehicles.values());
        }

        if (dataToExport.length > 0) {
            const formattedDate = new Date().toISOString().split('T')[0];
            exportToExcel(dataToExport, `Fairental-Report_${formattedDate}.xlsx`);
            setNotification({ message: `Successfully exported ${dataToExport.length} vehicles.`, type: 'success' });
        } else {
            setNotification({ message: 'No vehicles found matching the selected criteria.', type: 'error' });
        }
        setIsExportModalOpen(false);
    };

    const handleExportTodaysUpdates = () => {
        const todayVehicles = vehicles.filter(v => isToday(v.updated_at) || isToday(v.created_at));
        if (todayVehicles.length > 0) {
            const formattedDate = new Date().toISOString().split('T')[0];
            exportToExcel(todayVehicles, `Fairental_Todays-Updates_${formattedDate}.xlsx`);
            setNotification({ message: `Successfully exported ${todayVehicles.length} vehicles updated today.`, type: 'success' });
        } else {
            setNotification({ message: 'No vehicles were added or updated today.', type: 'error' });
        }
    };
    
    const handleSort = (key) => {
        if (sortKey === key) {
            setSortDirection(prev => (prev === 'asc' ? 'desc' : 'asc'));
        } else {
            setSortKey(key);
            setSortDirection('asc');
        }
    };

    const processedVehicles = useMemo(() => {
        let filtered = vehicles;
        switch (filter) {
            case 'insurance': filtered = vehicles.filter(v => isWithinDays(v.insurance_renewal_date, insuranceReminderDays)); break;
            case 'maintenance': filtered = vehicles.filter(v => isWithinDays(v.next_maintenance_date, maintenanceReminderDays)); break;
            case 'insurance_expired': filtered = vehicles.filter(v => isDatePast(v.insurance_renewal_date)); break;
            case 'maintenance_overdue': filtered = vehicles.filter(v => isDatePast(v.next_maintenance_date)); break;
            case 'all': default: filtered = vehicles; break;
        }
        if (searchQuery) {
            const lowercasedQuery = searchQuery.toLowerCase();
            filtered = filtered.filter(v => 
                v.make?.toLowerCase().includes(lowercasedQuery) || v.model?.toLowerCase().includes(lowercasedQuery) ||
                v.year?.toString().includes(lowercasedQuery) || v.license_plate?.toLowerCase().includes(lowercasedQuery) ||
                v.vin?.toLowerCase().includes(lowercasedQuery) || v.renter_name?.toLowerCase().includes(lowercasedQuery) ||
                v.insurance_company?.toLowerCase().includes(lowercasedQuery)
            );
        }
        if (sortKey) {
            filtered = [...filtered].sort((a, b) => {
                const valA = a[sortKey], valB = b[sortKey];
                if (!valA) return 1; if (!valB) return -1;
                const dateA = new Date(valA).getTime(), dateB = new Date(valB).getTime();
                if (isNaN(dateA)) return 1; if (isNaN(dateB)) return -1;
                return sortDirection === 'asc' ? dateA - dateB : dateB - dateA;
            });
        }
        return filtered;
    }, [vehicles, filter, insuranceReminderDays, maintenanceReminderDays, searchQuery, sortKey, sortDirection]);

    return (
        <div className="min-h-screen bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 font-sans">
            <Header onAddVehicle={handleAddVehicle} onFileUpload={handleFileUpload} onOpenSettings={() => setIsSettingsModalOpen(true)} onOpenExport={() => setIsExportModalOpen(true)} onExportTodaysUpdates={handleExportTodaysUpdates} />
            <main className="container mx-auto p-4 md:p-8">
                <FilterControls activeFilter={filter} onFilterChange={setFilter} insuranceDays={insuranceReminderDays} maintenanceDays={maintenanceReminderDays} searchQuery={searchQuery} onSearchChange={setSearchQuery} />
                {loading ? <div className="flex justify-center items-center h-64"><Spinner /></div> : 
                 error ? <div className="text-center text-red-700 dark:text-red-400 bg-red-100 dark:bg-red-900/20 p-6 rounded-xl"><p className="font-semibold text-lg">An Error Occurred</p><p className="mt-1">{error}</p></div> : 
                 <VehicleList vehicles={processedVehicles} onEdit={handleEditVehicle} onDelete={handleDeleteVehicle} onViewNotes={handleViewNotes} insuranceReminderDays={insuranceReminderDays} maintenanceReminderDays={maintenanceReminderDays} sortKey={sortKey} sortDirection={sortDirection} onSort={handleSort} />}
            </main>
            {isFormModalOpen && <VehicleFormModal isOpen={isFormModalOpen} onClose={() => setIsFormModalOpen(false)} onSubmit={handleFormSubmit} vehicle={selectedVehicle} />}
            {isNotesModalOpen && selectedVehicle && <NotesModal isOpen={isNotesModalOpen} onClose={() => setIsNotesModalOpen(false)} vehicle={selectedVehicle} onSave={async (updatedVehicle) => { await handleFormSubmit(updatedVehicle); }} summarizeNotes={summarizeNotes} />}
            {isSettingsModalOpen && <SettingsModal isOpen={isSettingsModalOpen} onClose={() => setIsSettingsModalOpen(false)} onSave={handleSaveSettings} currentSettings={{ insurance: insuranceReminderDays, maintenance: maintenanceReminderDays }} />}
            {isExportModalOpen && <ExportModal isOpen={isExportModalOpen} onClose={() => setIsExportModalOpen(false)} onExport={handleExportData} />}
            {notification && <div className={`fixed top-5 right-5 flex items-center p-4 rounded-xl shadow-2xl text-white ${notification.type === 'success' ? 'bg-green-600' : 'bg-red-600'}`}>{notification.type === 'success' ? <CheckCircleIcon className="h-6 w-6 mr-3" /> : <XCircleIcon className="h-6 w-6 mr-3" />}<span className="text-sm font-semibold">{notification.message}</span></div>}
        </div>
    );
};
// --- END: App.tsx ---

// --- START: index.tsx ---
const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}
const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
// --- END: index.tsx ---
    </script>
  </body>
</html>
